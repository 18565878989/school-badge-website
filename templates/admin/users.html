{% extends "admin/base.html" %}

{% block title %}{{ _('manage_users') }} - {{ _('admin_panel') }}{% endblock %}

{% block content %}
<div class="admin-header animate-in">
    <div>
        <h1>{{ _('manage_users') }}</h1>
        <p>管理系统用户和权限</p>
    </div>
    <div class="admin-header-actions">
        <button class="btn btn-primary" onclick="showModal('createUserModal')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            创建用户
        </button>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card animate-in">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="#1E3A5F" stroke-width="2">
                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/>
            </svg>
        </div>
        <div class="stat-info">
            <p class="stat-value">{{ users|length }}</p>
            <p class="stat-label">用户总数</p>
        </div>
    </div>
    
    <div class="stat-card animate-in">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="#FF9500" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
        </div>
        <div class="stat-info">
            <p class="stat-value">{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</p>
            <p class="stat-label">管理员</p>
        </div>
    </div>
    
    <div class="stat-card animate-in">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="#34C759" stroke-width="2">
                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
        </div>
        <div class="stat-info">
            <p class="stat-value">{{ users|selectattr('role', 'equalto', 'user')|list|length }}</p>
            <p class="stat-label">普通用户</p>
        </div>
    </div>
</div>

<!-- Users Table -->
<div class="card animate-in">
    <div class="card-header">
        <h2>所有用户</h2>
        <div class="filter-group" style="min-width: 200px; max-width: none;">
            <input type="text" id="searchUser" placeholder="搜索用户..." onkeyup="filterUsers()">
        </div>
    </div>
    <div class="table-container">
        <table class="data-table" id="usersTable">
            <thead>
                <tr>
                    <th width="60">ID</th>
                    <th>用户名</th>
                    <th>邮箱</th>
                    <th>手机号</th>
                    <th>角色</th>
                    <th>注册时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr data-search="{{ user.username|lower }}|{{ user.email|lower }}">
                    <td>{{ user.id }}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 36px; height: 36px; background: var(--bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--primary);">
                                {{ user.username[0].upper() }}
                            </div>
                            <span style="font-weight: 500;">{{ user.username }}</span>
                        </div>
                    </td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.phone or '—' }}</td>
                    <td>
                        {% if user.role == 'admin' %}
                            <span class="badge badge-warning">管理员</span>
                        {% elif user.role == 'editor' %}
                            <span class="badge badge-primary">编辑者</span>
                        {% elif user.role == 'viewer' %}
                            <span class="badge badge-secondary">访客</span>
                        {% else %}
                            <span class="badge badge-success">用户</span>
                        {% endif %}
                    </td>
                    <td>{{ user.created_at[:10] }}</td>
                    <td>
                        <div class="action-group">
                            <button class="btn btn-secondary btn-sm action-btn" onclick="editUser({{ user.id }})" title="编辑">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            {% if user.role != 'admin' %}
                            <button class="btn btn-danger btn-sm action-btn" onclick="deleteUser({{ user.id }})" title="删除">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"/>
                                    <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                </svg>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                            </svg>
                            <h3>暂无用户</h3>
                            <p>还没有注册用户</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create User Modal -->
<div class="modal" id="createUserModal">
    <div class="modal-header">
        <h2>创建新用户</h2>
        <button class="modal-close" onclick="hideModal('createUserModal')">&times;</button>
    </div>
    <form method="POST" action="{{ url_for('admin_create_user') }}">
        <div class="modal-body">
            <div class="form-grid">
                <div class="form-group">
                    <label for="username">用户名 *</label>
                    <input type="text" id="username" name="username" required minlength="3" maxlength="50" placeholder="请输入用户名">
                </div>
                <div class="form-group">
                    <label for="email">邮箱 *</label>
                    <input type="email" id="email" name="email" required placeholder="请输入邮箱">
                </div>
                <div class="form-group">
                    <label for="password">密码 *</label>
                    <input type="password" id="password" name="password" required minlength="6" placeholder="请输入密码">
                </div>
                <div class="form-group">
                    <label for="phone">手机号</label>
                    <input type="tel" id="phone" name="phone" placeholder="请输入手机号">
                </div>
                <div class="form-group full-width">
                    <label for="role">角色</label>
                    <select id="role" name="role">
                        <option value="user">普通用户</option>
                        <option value="editor">编辑者</option>
                        <option value="viewer">访客</option>
                        <option value="admin">管理员</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="hideModal('createUserModal')">取消</button>
            <button type="submit" class="btn btn-primary">创建</button>
        </div>
    </form>
</div>

<script>
function filterUsers() {
    const keyword = document.getElementById('searchUser').value.toLowerCase();
    const rows = document.querySelectorAll('#usersTable tbody tr');
    
    rows.forEach(row => {
        const match = !keyword || row.dataset.search.includes(keyword);
        row.style.display = match ? '' : 'none';
    });
}

function editUser(userId) {
    window.location.href = '/admin/users/' + userId + '/edit';
}

function deleteUser(userId) {
    if (confirm('确定要删除这个用户吗？此操作不可撤销。')) {
        window.location.href = '/admin/users/' + userId + '/delete';
    }
}
</script>
{% endblock %}
