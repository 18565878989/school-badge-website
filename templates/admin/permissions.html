{% extends "admin/base.html" %}

{% block title %}æƒé™ç®¡ç† - ç®¡ç†åå°{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>æƒé™ç®¡ç†</h1>
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
        &larr; è¿”å›ä»ªè¡¨ç›˜
    </a>
</div>

<div class="permission-container">
    <!-- è§’è‰²ç®¡ç† -->
    <div class="section">
        <h2>è§’è‰²ç®¡ç†</h2>
        <div class="role-cards">
            {% for role in roles %}
            <div class="role-card role-{{ role }}">
                <div class="role-header">
                    <h3>{{ role_names.get(role, role) }}</h3>
                    <span class="role-count">{{ role_stats.get(role, 0) }}äºº</span>
                </div>
                <div class="role-perms-count">
                    {% set perms = role_perms.get(role, []) %}
                    {{ perms|length }} é¡¹æƒé™
                </div>
                <div class="role-actions">
                    <button class="btn btn-sm btn-primary" onclick="showRolePermissions('{{ role }}')">
                        é…ç½®æƒé™
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- æƒé™å®šä¹‰ -->
    <div class="section">
        <h2>æƒé™å®šä¹‰</h2>
        <div class="permission-list">
            <div class="perm-category">
                <h4>ğŸ« å­¦æ ¡ç®¡ç†</h4>
                <div class="perm-items">
                    <span class="perm-tag">view_schools - æŸ¥çœ‹å­¦æ ¡</span>
                    <span class="perm-tag">like_schools - æ”¶è—å­¦æ ¡</span>
                    <span class="perm-tag">add_schools - æ·»åŠ å­¦æ ¡</span>
                    <span class="perm-tag">edit_all_schools - ç¼–è¾‘æ‰€æœ‰å­¦æ ¡</span>
                    <span class="perm-tag">delete_all_schools - åˆ é™¤æ‰€æœ‰å­¦æ ¡</span>
                </div>
            </div>
            <div class="perm-category">
                <h4>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h4>
                <div class="perm-items">
                    <span class="perm-tag">view_users - æŸ¥çœ‹ç”¨æˆ·</span>
                    <span class="perm-tag">edit_users - ç¼–è¾‘ç”¨æˆ·</span>
                    <span class="perm-tag">manage_users - ç®¡ç†ç”¨æˆ·æƒé™</span>
                    <span class="perm-tag">delete_users - åˆ é™¤ç”¨æˆ·</span>
                </div>
            </div>
            <div class="perm-category">
                <h4>âš™ï¸ ç³»ç»Ÿç®¡ç†</h4>
                <div class="perm-items">
                    <span class="perm-tag">view_logs - æŸ¥çœ‹æ—¥å¿—</span>
                    <span class="perm-tag">export_data - å¯¼å‡ºæ•°æ®</span>
                    <span class="perm-tag">manage_roles - ç®¡ç†è§’è‰²</span>
                    <span class="perm-tag">view_stats - æŸ¥çœ‹ç»Ÿè®¡</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æˆ·æƒé™ç®¡ç† -->
    <div class="section">
        <h2>ç”¨æˆ·æƒé™ç®¡ç†</h2>
        <table class="admin-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ç”¨æˆ·å</th>
                    <th>é‚®ç®±</th>
                    <th>è§’è‰²</th>
                    <th>æ•°æ®èŒƒå›´</th>
                    <th>ç™»å½•</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                        <select class="role-select" onchange="updateUserRole({{ user.id }}, this.value)">
                            <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>ç®¡ç†å‘˜</option>
                            <option value="editor" {% if user.role == 'editor' %}selected{% endif %}>ç¼–è¾‘è€…</option>
                            <option value="user" {% if user.role == 'user' %}selected{% endif %}>æ™®é€šç”¨æˆ·</option>
                            <option value="viewer" {% if user.role == 'viewer' %}selected{% endif %}>è®¿å®¢</option>
                        </select>
                    </td>
                    <td>{{ user.data_scope or 'own' }}</td>
                    <td>{{ user.login_count or 0 }}æ¬¡</td>
                    <td>
                        <span class="status-badge {{ user.status or 'active' }}">
                            {{ user.status or 'active' }}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="showUserPermissions({{ user.id }}, '{{ user.username }}', '{{ user.role }}')">
                            è¯¦ç»†æƒé™
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- è§’è‰²æƒé™é…ç½®æ¨¡æ€æ¡† -->
<div id="roleModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2 id="roleModalTitle">é…ç½®è§’è‰²æƒé™</h2>
            <button class="close-btn" onclick="closeModal('roleModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="rolePermissionForm" onsubmit="saveRolePermissions(event)">
                <input type="hidden" id="editRole" name="role">
                
                <div class="permission-groups">
                    <div class="perm-group">
                        <h4>ğŸ« å­¦æ ¡ç®¡ç†æƒé™</h4>
                        <div class="perm-checkboxes" id="perms-schools">
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="view_schools">
                                <span>æŸ¥çœ‹å­¦æ ¡</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="like_schools">
                                <span>æ”¶è—å­¦æ ¡</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="add_schools">
                                <span>æ·»åŠ å­¦æ ¡</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="edit_all_schools">
                                <span>ç¼–è¾‘æ‰€æœ‰å­¦æ ¡</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="delete_all_schools">
                                <span>åˆ é™¤æ‰€æœ‰å­¦æ ¡</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="perm-group">
                        <h4>ğŸ‘¥ ç”¨æˆ·ç®¡ç†æƒé™</h4>
                        <div class="perm-checkboxes" id="perms-users">
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="view_users">
                                <span>æŸ¥çœ‹ç”¨æˆ·</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="edit_users">
                                <span>ç¼–è¾‘ç”¨æˆ·</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="manage_users">
                                <span>ç®¡ç†ç”¨æˆ·æƒé™</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="delete_users">
                                <span>åˆ é™¤ç”¨æˆ·</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="perm-group">
                        <h4>âš™ï¸ ç³»ç»Ÿç®¡ç†æƒé™</h4>
                        <div class="perm-checkboxes" id="perms-system">
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="view_logs">
                                <span>æŸ¥çœ‹æ—¥å¿—</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="export_data">
                                <span>å¯¼å‡ºæ•°æ®</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="manage_roles">
                                <span>ç®¡ç†è§’è‰²</span>
                            </label>
                            <label class="perm-checkbox">
                                <input type="checkbox" name="permissions" value="view_stats">
                                <span>æŸ¥çœ‹ç»Ÿè®¡</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('roleModal')">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ç”¨æˆ·æƒé™è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="userModalTitle">ç”¨æˆ·æƒé™è¯¦æƒ…</h2>
            <button class="close-btn" onclick="closeModal('userModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="userPermissionDetails" class="user-perm-details">
                <!-- åŠ¨æ€å¡«å…… -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<script>
// è§’è‰²æƒé™æ•°æ® (ä»åç«¯ä¼ å…¥)
const rolePermissionsData = {{ role_perms | tojson }};

function showRolePermissions(role) {
    document.getElementById('editRole').value = role;
    document.getElementById('roleModalTitle').textContent = 'é…ç½® - ' + (roleNames[role] || role);
    
    // é‡ç½®æ‰€æœ‰checkbox
    document.querySelectorAll('#rolePermissionForm input[name="permissions"]').forEach(cb => {
        cb.checked = false;
    });
    
    // è®¾ç½®å·²é€‰ä¸­çš„æƒé™
    const rolePerms = rolePermissionsData[role] || [];
    document.querySelectorAll('#rolePermissionForm input[name="permissions"]').forEach(cb => {
        if (rolePerms.includes(cb.value)) {
            cb.checked = true;
        }
    });
    
    document.getElementById('roleModal').style.display = 'block';
}

function saveRolePermissions(event) {
    event.preventDefault();
    const role = document.getElementById('editRole').value;
    const perms = [];
    document.querySelectorAll('#rolePermissionForm input[name="permissions"]:checked').forEach(cb => {
        perms.push(cb.value);
    });
    
    fetch('/admin/role/' + role + '/permissions', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({permissions: perms})
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            closeModal('roleModal');
            alert('æƒé™ä¿å­˜æˆåŠŸï¼');
            location.reload();
        } else {
            alert('ä¿å­˜å¤±è´¥: ' + (d.message || 'æœªçŸ¥é”™è¯¯'));
        }
    })
    .catch(e => {
        alert('ä¿å­˜å¤±è´¥: ' + e);
    });
}

function updateUserRole(userId, role) {
    fetch('/admin/user/' + userId + '/role', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({role: role})
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            location.reload();
        } else {
            alert('æ›´æ–°å¤±è´¥: ' + (d.message || 'æœªçŸ¥é”™è¯¯'));
        }
    });
}

function showUserPermissions(userId, username, role) {
    document.getElementById('userModalTitle').textContent = username + ' - æƒé™è¯¦æƒ…';
    
    // è·å–ç”¨æˆ·æƒé™
    const rolePerms = rolePermissionsData[role] || [];
    
    // æŒ‰ç±»åˆ«åˆ†ç»„
    const perms = {
        schools: ['view_schools', 'like_schools', 'add_schools', 'edit_all_schools', 'delete_all_schools'],
        users: ['view_users', 'edit_users', 'manage_users', 'delete_users'],
        system: ['view_logs', 'export_data', 'manage_roles', 'view_stats']
    };
    
    const permNames = {
        'view_schools': 'æŸ¥çœ‹å­¦æ ¡',
        'like_schools': 'æ”¶è—å­¦æ ¡',
        'add_schools': 'æ·»åŠ å­¦æ ¡',
        'edit_all_schools': 'ç¼–è¾‘æ‰€æœ‰å­¦æ ¡',
        'delete_all_schools': 'åˆ é™¤æ‰€æœ‰å­¦æ ¡',
        'view_users': 'æŸ¥çœ‹ç”¨æˆ·',
        'edit_users': 'ç¼–è¾‘ç”¨æˆ·',
        'manage_users': 'ç®¡ç†ç”¨æˆ·æƒé™',
        'delete_users': 'åˆ é™¤ç”¨æˆ·',
        'view_logs': 'æŸ¥çœ‹æ—¥å¿—',
        'export_data': 'å¯¼å‡ºæ•°æ®',
        'manage_roles': 'ç®¡ç†è§’è‰²',
        'view_stats': 'æŸ¥çœ‹ç»Ÿè®¡'
    };
    
    let html = '';
    html += '<div class="user-role-info">';
    html += '<p><strong>å½“å‰è§’è‰²:</strong> ' + (roleNames[role] || role) + '</p>';
    html += '</div>';
    
    for (const [category, codes] of Object.entries(perms)) {
        html += '<div class="perm-category-detail">';
        html += '<h5>' + (category === 'schools' ? 'ğŸ« å­¦æ ¡ç®¡ç†' : category === 'users' ? 'ğŸ‘¥ ç”¨æˆ·ç®¡ç†' : 'âš™ï¸ ç³»ç»Ÿç®¡ç†') + '</h5>';
        html += '<div class="perm-list">';
        
        for (const code of codes) {
            const has = rolePerms.includes(code);
            html += '<span class="perm-item ' + (has ? 'has' : 'no') + '">';
            html += (has ? 'âœ…' : 'âŒ') + ' ' + permNames[code];
            html += '</span>';
        }
        
        html += '</div></div>';
    }
    
    document.getElementById('userPermissionDetails').innerHTML = html;
    document.getElementById('userModal').style.display = 'block';
}

function closeModal(id) {
    document.getElementById(id).style.display = 'none';
}

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
};

const roleNames = {{ role_names | tojson }};
</script>

<style>
.permission-container {
    display: grid;
    gap: 30px;
}

.section {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.section h2 {
    margin: 0 0 20px 0;
    font-size: 18px;
    color: #333;
}

.role-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.role-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
}

.role-card.role-admin {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.role-card.role-editor {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.role-card.role-user {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.role-card.role-viewer {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.role-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.role-header h3 {
    margin: 0;
    font-size: 18px;
}

.role-count {
    background: rgba(255,255,255,0.2);
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
}

.role-perms-count {
    font-size: 12px;
    opacity: 0.9;
    margin-bottom: 15px;
}

.role-actions {
    display: flex;
    gap: 10px;
}

.role-actions .btn {
    flex: 1;
}

.permission-list {
    display: grid;
    gap: 15px;
}

.perm-category {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
}

.perm-category h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
}

.perm-items {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.perm-tag {
    background: #e3f2fd;
    color: #1976d2;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 12px;
}

.role-select {
    padding: 5px 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
}

.status-badge.active {
    background: #e3f2fd;
    color: #1976d2;
}

.status-badge.disabled {
    background: #ffebee;
    color: #c62828;
}

/* æ¨¡æ€æ¡† */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}

.modal-content {
    background: white;
    margin: 50px auto;
    width: 90%;
    max-width: 700px;
    border-radius: 10px;
    overflow: hidden;
}

.modal-content.modal-lg {
    max-width: 800px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: #f5f5f5;
    border-bottom: 1px solid #eee;
}

.modal-header h2 {
    margin: 0;
    font-size: 18px;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.modal-body {
    padding: 20px;
    max-height: 70vh;
    overflow-y: auto;
}

.modal-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #eee;
}

.permission-groups {
    display: grid;
    gap: 20px;
}

.perm-group h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #333;
}

.perm-checkboxes {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
}

.perm-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: #f5f5f5;
    border-radius: 5px;
    cursor: pointer;
}

.perm-checkbox:hover {
    background: #eee;
}

.perm-checkbox input {
    cursor: pointer;
}

/* ç”¨æˆ·æƒé™è¯¦æƒ… */
.user-perm-details {
    display: grid;
    gap: 15px;
}

.user-role-info {
    background: #e3f2fd;
    padding: 15px;
    border-radius: 8px;
}

.user-role-info p {
    margin: 0;
}

.perm-category-detail {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
}

.perm-category-detail h5 {
    margin: 0 0 10px 0;
    font-size: 14px;
}

.perm-list {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.perm-item {
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 13px;
}

.perm-item.has {
    background: #e8f5e9;
    color: #2e7d32;
}

.perm-item.no {
    background: #ffebee;
    color: #c62828;
}
</style>
{% endblock %}
