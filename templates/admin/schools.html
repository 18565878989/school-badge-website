{% extends "admin/base.html" %}

{% block title %}{{ _('manage_schools') }} - {{ _('admin_panel') }}{% endblock %}

{% block content %}
<div class="admin-header animate-in">
    <div>
        <h1>{{ _('manage_schools') }}</h1>
        <p>管理所有学校数据</p>
    </div>
    <div class="admin-header-actions">
        <a href="{{ url_for('admin_add_school') }}" class="btn btn-primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            {{ _('add_school') }}
        </a>
    </div>
</div>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card animate-in">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="#1E3A5F" stroke-width="2">
                <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                <path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5"/>
            </svg>
        </div>
        <div class="stat-info">
            <p class="stat-value">{{ schools|length }}</p>
            <p class="stat-label">学校总数</p>
        </div>
    </div>
    
    <div class="stat-card animate-in">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="#FF9500" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                <circle cx="12" cy="10" r="3"/>
            </svg>
        </div>
        <div class="stat-info">
            <p class="stat-value">{{ schools|selectattr('region', 'equalto', 'Hong Kong')|list|length }}</p>
            <p class="stat-label">香港学校</p>
        </div>
    </div>
    
    <div class="stat-card animate-in">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
            </svg>
        </div>
        <div class="stat-info">
            <p class="stat-value">{{ level_stats.university if level_stats else 0 }}</p>
            <p class="stat-label">大学</p>
        </div>
    </div>
    
    <div class="stat-card animate-in">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="#34C759" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
            </svg>
        </div>
        <div class="stat-info">
            <p class="stat-value">{{ level_stats.middle if level_stats else 0 }}</p>
            <p class="stat-label">中学</p>
        </div>
    </div>
    
    <div class="stat-card animate-in">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="#AF52DE" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
            </svg>
        </div>
        <div class="stat-info">
            <p class="stat-value">{{ level_stats.primary if level_stats else 0 }}</p>
            <p class="stat-label">小学</p>
        </div>
    </div>
    
    <div class="stat-card animate-in">
        <div class="stat-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="#D4AF37" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                <line x1="9" y1="9" x2="9.01" y2="9"/>
                <line x1="15" y1="9" x2="15.01" y2="9"/>
            </svg>
        </div>
        <div class="stat-info">
            <p class="stat-value">{{ level_stats.kindergarten if level_stats else 0 }}</p>
            <p class="stat-label">幼儿园</p>
        </div>
    </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar animate-in">
    <div class="filter-group">
        <label>搜索</label>
        <input type="text" id="searchKeyword" placeholder="学校名称、中文名..." onkeyup="filterTable()">
    </div>
    <div class="filter-group">
        <label>地区</label>
        <select id="filterRegion" onchange="filterTable()">
            <option value="">全部地区</option>
            {% for region in regions %}
                <option value="{{ region }}">{{ region }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label>类型</label>
        <select id="filterLevel" onchange="filterTable()">
            <option value="">全部类型</option>
            <option value="university">大学</option>
            <option value="middle">中学</option>
            <option value="primary">小学</option>
            <option value="kindergarten">幼儿园</option>
            <option value="elementary">特殊</option>
        </select>
    </div>
    <div class="filter-group">
        <label>办学</label>
        <select id="filterFinance" onchange="filterTable()">
            <option value="">全部</option>
            <option value="Government">官立</option>
            <option value="Aided">资助</option>
            <option value="Direct">直资</option>
            <option value="Private">私立</option>
            <option value="ESF">英基</option>
        </select>
    </div>
    <div class="filter-group">
        <label>性别</label>
        <select id="filterGender" onchange="filterTable()">
            <option value="">全部</option>
            <option value="CO-ED">男女校</option>
            <option value="GIRLS">女校</option>
            <option value="BOYS">男校</option>
        </select>
    </div>
    <div class="filter-actions">
        <span id="filterCount" class="filter-count">显示: {{ schools|length }} 所学校</span>
        <button onclick="resetFilters()" class="btn btn-secondary btn-sm">重置</button>
    </div>
</div>

<!-- Schools Table -->
<div class="card animate-in">
    <div class="table-container">
        <table class="data-table" id="schoolsTable">
            <thead>
                <tr>
                    <th width="50"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                    <th width="60">ID</th>
                    <th width="60">校徽</th>
                    <th>学校名称</th>
                    <th>中文名</th>
                    <th>地区</th>
                    <th>类型</th>
                    <th>办学</th>
                    <th>性别</th>
                    <th>来源</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for school in schools %}
                <tr data-region="{{ school.region or '' }}" 
                    data-level="{{ school.level or '' }}"
                    data-finance="{{ school.finance_type or '' }}"
                    data-gender="{{ school.gender or '' }}"
                    data-source="{{ school.source or 'manual' }}"
                    data-search="{{ (school.name or '')|lower }}|{{(school.name_cn or '')|lower }}">
                    <td><input type="checkbox" class="school-checkbox" value="{{ school.id }}"></td>
                    <td>{{ school.id }}</td>
                    <td>
                        {% if school.badge_url and school.badge_url != '/static/badges/default.svg' %}
                            <img src="{{ school.badge_url }}" alt="{{ school.name }}" class="table-badge" loading="lazy">
                        {% else %}
                            <span style="color: var(--text-tertiary);">—</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('school_detail', school_id=school.id) }}" target="_blank" style="font-weight: 500;">
                            {{ school.name[:40] }}{% if school.name|length > 40 %}...{% endif %}
                        </a>
                    </td>
                    <td>{{ school.name_cn or '—' }}</td>
                    <td>{{ school.region or '—' }}</td>
                    <td>
                        <span class="badge badge-secondary">
                            {% if school.level == 'university' %}大学
                            {% elif school.level == 'middle' %}中学
                            {% elif school.level == 'elementary' %}特殊
                            {% elif school.level == 'primary' %}小学
                            {% elif school.level == 'kindergarten' %}幼儿园
                            {% else %}—{% endif %}
                        </span>
                    </td>
                    <td>
                        {% if school.finance_type %}
                            <span class="badge badge-primary" style="font-size: 0.7rem;">
                                {% if school.finance_type == 'Government' %}官立
                                {% elif school.finance_type == 'Aided' %}资助
                                {% elif school.finance_type == 'Direct' %}直资
                                {% elif school.finance_type == 'Private' %}私立
                                {% elif school.finance_type == 'ESF' %}英基
                                {% else %}{{ school.finance_type }}{% endif %}
                            </span>
                        {% else %}
                            <span style="color: var(--text-tertiary);">—</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if school.gender %}
                            {% if school.gender == 'CO-ED' %}<span class="badge badge-success">男女</span>
                            {% elif school.gender == 'GIRLS' %}<span class="badge badge-warning">女校</span>
                            {% elif school.gender == 'BOYS' %}<span class="badge badge-primary">男校</span>
                            {% else %}<span class="badge badge-secondary">{{ school.gender }}</span>{% endif %}
                        {% else %}
                            <span style="color: var(--text-tertiary);">—</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if school.source == 'schooland.hk' %}
                            <span class="badge badge-primary">schooland.hk</span>
                        {% else %}
                            <span class="badge badge-success">手动</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-group">
                            <a href="{{ url_for('admin_edit_school', school_id=school.id) }}" class="btn btn-secondary btn-sm action-btn" title="编辑">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </a>
                            <a href="{{ url_for('school_detail', school_id=school.id) }}" class="btn btn-secondary btn-sm action-btn" target="_blank" title="查看">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                            </a>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="11">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M22 10v6M2 10l10-5 10 5-10 5z"/>
                                <path d="M6 12v5c0 2 2 3 6 3s6-1 6-3v-5"/>
                            </svg>
                            <h3>暂无学校</h3>
                            <p>还没有添加任何学校</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
function filterTable() {
    const keyword = document.getElementById('searchKeyword').value.toLowerCase();
    const region = document.getElementById('filterRegion').value;
    const level = document.getElementById('filterLevel').value;
    const finance = document.getElementById('filterFinance').value;
    const gender = document.getElementById('filterGender').value;
    
    const rows = document.querySelectorAll('#schoolsTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const searchMatch = !keyword || 
            row.dataset.search.includes(keyword) ||
            row.querySelector('td:nth-child(4)')?.textContent.toLowerCase().includes(keyword) ||
            row.querySelector('td:nth-child(5)')?.textContent.toLowerCase().includes(keyword);
        
        const regionMatch = !region || row.dataset.region === region;
        const levelMatch = !level || row.dataset.level === level;
        const financeMatch = !finance || row.dataset.finance === finance;
        const genderMatch = !gender || row.dataset.gender === gender;
        
        const match = searchMatch && regionMatch && levelMatch && financeMatch && genderMatch;
        row.style.display = match ? '' : 'none';
        
        if (match) visibleCount++;
    });
    
    document.getElementById('filterCount').textContent = `显示: ${visibleCount} 所学校`;
}

function resetFilters() {
    document.getElementById('searchKeyword').value = '';
    document.getElementById('filterRegion').value = '';
    document.getElementById('filterLevel').value = '';
    document.getElementById('filterFinance').value = '';
    document.getElementById('filterGender').value = '';
    filterTable();
}

function toggleSelectAll() {
    const checkbox = document.getElementById('selectAll');
    document.querySelectorAll('.school-checkbox').forEach(cb => cb.checked = checkbox.checked);
}
</script>
{% endblock %}
