{% extends "admin/base.html" %}

{% block title %}{{ _('manage_schools') }} - {{ _('admin_panel') }}{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>{{ _('manage_schools') }}</h1>
    <div class="header-actions">
        <a href="{{ url_for('admin_add_school') }}" class="btn btn-primary">
            â• {{ _('add_school') }}
        </a>
    </div>
</div>

<!-- æ•°æ®ç»Ÿè®¡å¡ç‰‡ -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">{{ schools|length }}</div>
        <div class="stat-label">å­¦æ ¡æ€»æ•°</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ schools|selectattr('region', 'equalto', 'Hong Kong')|list|length }}</div>
        <div class="stat-label">é¦™æ¸¯å­¦æ ¡</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ level_stats.university if level_stats else 0 }}</div>
        <div class="stat-label">å¤§å­¦</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ level_stats.middle if level_stats else 0 }}</div>
        <div class="stat-label">ä¸­å­¦</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ level_stats.elementary if level_stats else 0 }}</div>
        <div class="stat-label">å°å­¦</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ level_stats.kindergarten if level_stats else 0 }}</div>
        <div class="stat-label">å¹¼å„¿å›­</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ schools|selectattr('source', 'equalto', 'schooland.hk')|list|length }}</div>
        <div class="stat-label">schooland.hk</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ schools|selectattr('source', 'equalto', 'manual')|list|length }}</div>
        <div class="stat-label">æ‰‹åŠ¨æ·»åŠ </div>
    </div>
</div>

<!-- å¢å¼ºçš„æœç´¢è¿‡æ»¤åŒºåŸŸ -->
<div class="filter-bar">
    <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 16px;">
        <div class="filter-group">
            <label>ğŸ” å…³é”®è¯æœç´¢</label>
            <input type="text" id="searchKeyword" placeholder="å­¦æ ¡åç§°ã€ä¸­æ–‡åã€åœ°å€..." onkeyup="filterTable()">
        </div>
        <div class="filter-group">
            <label>ğŸ“ åœ°åŒº</label>
            <select id="filterRegion" onchange="filterTable()">
                <option value="">å…¨éƒ¨åœ°åŒº</option>
                {% for region in regions %}
                    <option value="{{ region }}">{{ region }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label>ğŸ« å­¦æ ¡ç±»å‹</label>
            <select id="filterLevel" onchange="filterTable()">
                <option value="">å…¨éƒ¨ç±»å‹</option>
                <option value="university">å¤§å­¦</option>
                <option value="middle">ä¸­å­¦</option>
                <option value="primary">å°å­¦</option>
                <option value="kindergarten">å¹¼å„¿å›­</option>
                <option value="elementary">ç‰¹æ®Šå­¦æ ¡</option>
            </select>
        </div>
        <div class="filter-group">
            <label>ğŸ’° åŠå­¦ç±»å‹</label>
            <select id="filterFinance" onchange="filterTable()">
                <option value="">å…¨éƒ¨ç±»å‹</option>
                <option value="Government">å®˜ç«‹</option>
                <option value="Aided">èµ„åŠ©</option>
                <option value="Direct">ç›´èµ„</option>
                <option value="Private">ç§ç«‹</option>
                <option value="ESF">è‹±åŸº</option>
            </select>
        </div>
        <div class="filter-group">
            <label>ğŸ‘¥ æ€§åˆ«</label>
            <select id="filterGender" onchange="filterTable()">
                <option value="">å…¨éƒ¨</option>
                <option value="CO-ED">ç”·å¥³æ ¡</option>
                <option value="GIRLS">å¥³æ ¡</option>
                <option value="BOYS">ç”·æ ¡</option>
            </select>
        </div>
        <div class="filter-group">
            <label>ğŸ“¡ æ•°æ®æ¥æº</label>
            <select id="filterSource" onchange="filterTable()">
                <option value="">å…¨éƒ¨æ¥æº</option>
                <option value="edb">æ•™è‚²å±€EDB</option>
                <option value="manual">æ‰‹åŠ¨æ·»åŠ </option>
                <option value="batch3">æ‰¹é‡å¯¼å…¥</option>
            </select>
        </div>
    </div>
    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
        <span id="filterCount" style="font-size: 0.9rem; color: var(--text-secondary);">æ˜¾ç¤º: 0 æ‰€å­¦æ ¡</span>
        <button onclick="resetFilters()" class="btn btn-secondary">ğŸ”„ é‡ç½®ç­›é€‰</button>
        <button onclick="exportFiltered()" class="btn btn-secondary">ğŸ“¤ å¯¼å‡ºé€‰ä¸­</button>
    </div>
</div>

<table class="admin-table" id="schoolsTable">
    <thead>
        <tr>
            <th width="40"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
            <th width="60">ID</th>
            <th width="60">æ ¡å¾½</th>
            <th>å­¦æ ¡åç§°</th>
            <th>ä¸­æ–‡å</th>
            <th width="90">åœ°åŒº</th>
            <th width="70">ç±»å‹</th>
            <th width="70">åŠå­¦</th>
            <th width="70">æ€§åˆ«</th>
            <th width="100">æ•°æ®æ¥æº</th>
            <th width="90">æ›´æ–°æ—¶é—´</th>
            <th width="100">æ“ä½œ</th>
        </tr>
    </thead>
    <tbody>
        {% for school in schools %}
        <tr data-region="{{ school.region or '' }}" 
            data-level="{{ school.level or '' }}"
            data-finance="{{ school.finance_type or '' }}"
            data-gender="{{ school.gender or '' }}"
            data-source="{{ school.source or 'manual' }}"
            data-search="{{ (school.name or '')|lower }}|{{(school.name_cn or '')|lower }}|{{(school.address or '')|lower }}">
            <td><input type="checkbox" class="school-checkbox" value="{{ school.id }}"></td>
            <td>{{ school.id }}</td>
            <td>
                {% if school.badge_url and school.badge_url != '/static/badges/default.svg' %}
                    <img src="{{ school.badge_url }}" alt="{{ school.name }}" class="table-badge" loading="lazy">
                {% else %}
                    <span class="no-badge">â€”</span>
                {% endif %}
            </td>
            <td>
                <a href="{{ url_for('school_detail', school_id=school.id) }}" target="_blank" class="school-link" title="{{ school.name }}">
                    {{ school.name[:40] }}{% if school.name|length > 40 %}...{% endif %}
                </a>
            </td>
            <td>{{ school.name_cn or 'â€”' }}</td>
            <td>{{ school.region or 'â€”' }}</td>
            <td>
                <span class="level-badge level-{{ school.level }}">
                    {% if school.level == 'university' %}å¤§å­¦
                    {% elif school.level == 'middle' %}ä¸­å­¦
                    {% elif school.level == 'elementary' %}ç‰¹æ®Š
                    {% elif school.level == 'primary' %}å°å­¦
                    {% elif school.level == 'kindergarten' %}å¹¼å„¿å›­
                    {% else %}â€”{% endif %}
                </span>
            </td>
            <td>
                {% if school.finance_type %}
                    <span class="finance-badge finance-{{ school.finance_type|lower }}">
                        {% if school.finance_type == 'Government' %}å®˜ç«‹
                        {% elif school.finance_type == 'Aided' %}èµ„åŠ©
                        {% elif school.finance_type == 'Direct' %}ç›´èµ„
                        {% elif school.finance_type == 'Private' %}ç§ç«‹
                        {% elif school.finance_type == 'ESF' %}è‹±åŸº
                        {% else %}{{ school.finance_type }}{% endif %}
                    </span>
                {% else %}
                    â€”
                {% endif %}
            </td>
            <td>
                {% if school.gender == 'CO-ED' %}ç”·å¥³
                {% elif school.gender == 'GIRLS' %}å¥³æ ¡
                {% elif school.gender == 'BOYS' %}ç”·æ ¡
                {% else %}â€”{% endif %}
            </td>
            <td>
                {% if school.source == 'edb' %}
                    <span class="source-badge source-edb">EDB</span>
                {% elif school.source == 'manual' %}
                    <span class="source-badge source-manual">æ‰‹åŠ¨</span>
                {% elif school.source == 'batch3' %}
                    <span class="source-badge source-batch">æ‰¹é‡</span>
                {% else %}
                    <span class="source-badge source-other">å…¶ä»–</span>
                {% endif %}
            </td>
            <td>{{ school.updated_at[:10] if school.updated_at else 'â€”' }}</td>
            <td>
                <div class="action-group">
                    <a href="{{ url_for('admin_edit_school', school_id=school.id) }}" class="btn btn-sm btn-secondary" title="ç¼–è¾‘">âœï¸</a>
                    <a href="{{ url_for('school_detail', school_id=school.id) }}" target="_blank" class="btn btn-sm btn-secondary" title="æŸ¥çœ‹">ğŸ‘ï¸</a>
                    <a href="{{ url_for('admin_delete_school', school_id=school.id) }}" 
                       class="btn btn-sm btn-danger"
                       onclick="return confirm('ç¡®å®šåˆ é™¤è¿™æ‰€å­¦æ ¡?')"
                       title="åˆ é™¤">ğŸ—‘ï¸</a>
                </div>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="12" class="empty">æš‚æ— å­¦æ ¡æ•°æ®</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="table-footer">
    <div class="pagination-info">
        å…± <span id="totalCount">{{ schools|length }}</span> æ‰€å­¦æ ¡ï¼Œ 
        å½“å‰æ˜¾ç¤º <span id="visibleCount">0</span> æ‰€
    </div>
</div>

<script>
function filterTable() {
    const keyword = document.getElementById('searchKeyword').value.toLowerCase();
    const region = document.getElementById('filterRegion').value;
    const level = document.getElementById('filterLevel').value;
    const finance = document.getElementById('filterFinance').value;
    const gender = document.getElementById('filterGender').value;
    const source = document.getElementById('filterSource').value;
    
    const rows = document.querySelectorAll('#schoolsTable tbody tr[data-search]');
    let visible = 0;
    
    rows.forEach(row => {
        const searchText = row.dataset.search || '';
        const rowRegion = row.dataset.region || '';
        const rowLevel = row.dataset.level || '';
        const rowFinance = row.dataset.finance || '';
        const rowGender = row.dataset.gender || '';
        const rowSource = row.dataset.source || '';
        
        const matchesKeyword = !keyword || searchText.includes(keyword);
        const matchesRegion = !region || rowRegion === region;
        const matchesLevel = !level || rowLevel === level;
        const matchesFinance = !finance || rowFinance === finance;
        const matchesGender = !gender || rowGender === gender;
        const matchesSource = !source || rowSource === source;
        
        const visible_row = matchesKeyword && matchesRegion && matchesLevel && 
                          matchesFinance && matchesGender && matchesSource;
        
        row.style.display = visible_row ? '' : 'none';
        if (visible_row) visible++;
    });
    
    document.getElementById('filterCount').textContent = `æ˜¾ç¤º: ${visible} æ‰€å­¦æ ¡`;
    document.getElementById('visibleCount').textContent = visible;
    
    // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
    updateSelectAllState();
}

function resetFilters() {
    document.getElementById('searchKeyword').value = '';
    document.getElementById('filterRegion').value = '';
    document.getElementById('filterLevel').value = '';
    document.getElementById('filterFinance').value = '';
    document.getElementById('filterGender').value = '';
    document.getElementById('filterSource').value = '';
    filterTable();
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.school-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = selectAll.checked;
    });
}

function updateSelectAllState() {
    const checkboxes = document.querySelectorAll('.school-checkbox');
    const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
        return cb.closest('tr').style.display !== 'none';
    });
    const allChecked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
    document.getElementById('selectAll').checked = allChecked;
}

function exportFiltered() {
    const visibleRows = document.querySelectorAll('#schoolsTable tbody tr[style=""]');
    const ids = Array.from(visibleRows).map(row => {
        return row.querySelector('.school-checkbox')?.value;
    }).filter(Boolean);
    
    if (ids.length === 0) {
        alert('æ²¡æœ‰é€‰ä¸­çš„å­¦æ ¡');
        return;
    }
    
    alert(`å°†å¯¼å‡º ${ids.length} æ‰€å­¦æ ¡çš„æ•°æ®`);
    // TODO: å®ç°å¯¼å‡ºåŠŸèƒ½
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    filterTable();
});
</script>

<style>
.search-section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.search-row {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    margin-bottom: 15px;
}

.search-group {
    flex: 1;
    min-width: 150px;
}

.search-group label {
    display: block;
    font-size: 12px;
    color: #666;
    margin-bottom: 5px;
}

.search-group input,
.search-group select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.filter-actions {
    display: flex;
    align-items: center;
    gap: 15px;
    padding-top: 10px;
    border-top: 1px solid #eee;
}

.filter-count {
    font-size: 14px;
    color: #666;
}

.table-footer {
    display: flex;
    justify-content: flex-end;
    padding: 15px 0;
}

.pagination-info {
    font-size: 14px;
    color: #666;
}

.admin-table {
    width: 100%;
    border-collapse: collapse;
}

.admin-table th {
    background: #f8f9fa;
    padding: 12px 8px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    color: #666;
    border-bottom: 2px solid #eee;
}

.admin-table td {
    padding: 10px 8px;
    border-bottom: 1px solid #eee;
    font-size: 13px;
}

.admin-table tbody tr:hover {
    background: #f8f9fa;
}

.level-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 500;
}

.level-university { background: #e3f2fd; color: #1976d2; }
.level-middle { background: #e8f5e9; color: #388e3c; }
.level-primary { background: #fff3e0; color: #f57c00; }
.level-kindergarten { background: #fce4ec; color: #c2185b; }
.level-elementary { background: #f3e5f5; color: #7b1fa2; }

.finance-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
}

.finance-government { background: #bbdefb; color: #1565c0; }
.finance-aided { background: #c8e6c9; color: #2e7d32; }
.finance-direct { background: #fff9c4; color: #f9a825; }
.finance-private { background: #ffccbc; color: #d84315; }
.finance-esf { background: #e1bee7; color: #7b1fa2; }

.source-badge {
    display: inline-block;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: 500;
}

.source-edb { background: #bbdefb; color: #1976d2; }
.source-manual { background: #f5f5f5; color: #666; }
.source-batch { background: #c8e6c9; color: #2e7d32; }

.table-badge {
    width: 36px;
    height: 36px;
    object-fit: contain;
    border-radius: 5px;
}

.action-group {
    display: flex;
    gap: 4px;
}

.btn-sm {
    padding: 4px 6px;
    font-size: 12px;
    border-radius: 4px;
}

.btn-secondary {
    background: #f5f5f5;
    color: #666;
    border: 1px solid #ddd;
}

.btn-secondary:hover {
    background: #e0e0e0;
}

.no-badge {
    color: #999;
    font-size: 18px;
}

.school-link {
    color: #333;
    text-decoration: none;
}

.school-link:hover {
    color: #667eea;
}
</style>

<style>
.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
}

.stat-card:nth-child(2) {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.stat-card:nth-child(3) {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.stat-card:nth-child(4) {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.stat-number {
    font-size: 32px;
    font-weight: bold;
}

.stat-label {
    font-size: 14px;
    opacity: 0.9;
    margin-top: 5px;
}

.filter-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filter-bar input,
.filter-bar select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.filter-bar input {
    flex: 1;
    min-width: 200px;
}

.table-badge {
    width: 40px;
    height: 40px;
    object-fit: contain;
    border-radius: 5px;
}

.school-link {
    color: #333;
    text-decoration: none;
}

.school-link:hover {
    color: #667eea;
}

.source-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.source-schooland {
    background: #e3f2fd;
    color: #1976d2;
}

.source-manual {
    background: #f5f5f5;
    color: #666;
}

.action-group {
    display: flex;
    gap: 5px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.admin-header h1 {
    margin: 0;
    font-size: 24px;
    color: #333;
}
</style>
{% endblock %}
