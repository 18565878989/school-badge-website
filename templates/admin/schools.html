{% extends "admin/base.html" %}

{% block title %}{{ _('manage_schools') }} - {{ _('admin_panel') }}{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>{{ _('manage_schools') }}</h1>
    <div class="header-actions">
        <a href="{{ url_for('admin_add_school') }}" class="btn btn-primary">
            ‚ûï {{ _('add_school') }}
        </a>
    </div>
</div>

<!-- Êï∞ÊçÆÁªüËÆ°Âç°Áâá -->
<div class="stats-cards">
    <div class="stat-card">
        <div class="stat-number">{{ schools|length }}</div>
        <div class="stat-label">Â≠¶Ê†°ÊÄªÊï∞</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ schools|selectattr('region', 'equalto', 'Hong Kong')|list|length }}</div>
        <div class="stat-label">È¶ôÊ∏ØÂ≠¶Ê†°</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ schools|selectattr('source', 'equalto', 'schooland.hk')|list|length }}</div>
        <div class="stat-label">schooland.hk</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ schools|selectattr('source', 'equalto', 'manual')|list|length }}</div>
        <div class="stat-label">ÊâãÂä®Ê∑ªÂä†</div>
    </div>
</div>

<div class="filter-bar">
    <input type="text" id="searchSchools" placeholder="ÊêúÁ¥¢Â≠¶Ê†°..." onkeyup="filterTable()">
    <select id="filterRegion" onchange="filterTable()">
        <option value="">ÊâÄÊúâÂú∞Âå∫</option>
        {% for region in ['North America', 'Europe', 'Asia', 'Oceania', 'Africa', 'South America', 'Hong Kong'] %}
            <option value="{{ region }}">{{ region }}</option>
        {% endfor %}
    </select>
    <select id="filterSource" onchange="filterTable()">
        <option value="">ÊâÄÊúâÊù•Ê∫ê</option>
        <option value="schooland.hk">schooland.hk</option>
        <option value="manual">ÊâãÂä®Ê∑ªÂä†</option>
    </select>
</div>

<table class="admin-table" id="schoolsTable">
    <thead>
        <tr>
            <th width="60">ID</th>
            <th width="60">Ê†°ÂæΩ</th>
            <th>Â≠¶Ê†°ÂêçÁß∞</th>
            <th>‰∏≠ÊñáÂêç</th>
            <th width="100">Âú∞Âå∫</th>
            <th width="80">Á±ªÂûã</th>
            <th width="120">Êï∞ÊçÆÊù•Ê∫ê</th>
            <th width="100">Êõ¥Êñ∞Êó∂Èó¥</th>
            <th width="120">Êìç‰Ωú</th>
        </tr>
    </thead>
    <tbody>
        {% for school in schools %}
        <tr data-region="{{ school.region }}" data-source="{{ school.source or 'manual' }}">
            <td>{{ school.id }}</td>
            <td>
                {% if school.badge_url %}
                    <img src="{{ school.badge_url }}" alt="{{ school.name }}" class="table-badge">
                {% else %}
                    <span class="no-badge">‚Äî</span>
                {% endif %}
            </td>
            <td>
                <a href="{{ url_for('school_detail', school_id=school.id) }}" target="_blank" class="school-link">
                    {{ school.name }}
                </a>
            </td>
            <td>{{ school.name_cn or '‚Äî' }}</td>
            <td>{{ school.region }}</td>
            <td>
                <span class="level-badge level-{{ school.level }}">
                    {% if school.level == 'university' %}Â§ßÂ≠¶
                    {% elif school.level == 'middle' %}‰∏≠Â≠¶
                    {% elif school.level == 'elementary' %}Â∞èÂ≠¶
                    {% else %}ÂπºÂÑøÂõ≠{% endif %}
                </span>
            </td>
            <td>
                {% if school.source == 'schooland.hk' %}
                    <span class="source-badge source-schooland">schooland.hk</span>
                {% elif school.source %}
                    <span class="source-badge source-{{ school.source }}">{{ school.source }}</span>
                {% else %}
                    <span class="source-badge source-manual">ÊâãÂä®</span>
                {% endif %}
            </td>
            <td>
                {% if school.updated_at %}
                    {{ school.updated_at[:10] }}
                {% else %}
                    ‚Äî
                {% endif %}
            </td>
            <td>
                <div class="action-group">
                    <a href="{{ url_for('admin_edit_school', school_id=school.id) }}" class="btn btn-sm btn-secondary" title="ÁºñËæë">
                        ‚úèÔ∏è
                    </a>
                    <a href="{{ url_for('admin_delete_school', school_id=school.id) }}" 
                       class="btn btn-sm btn-danger"
                       onclick="return confirm('Á°ÆÂÆöÂà†Èô§?')"
                       title="Âà†Èô§">
                        üóëÔ∏è
                    </a>
                </div>
            </td>
        </tr>
        {% else %}
        <tr>
            <td colspan="9" class="empty">ÊöÇÊó†Â≠¶Ê†°Êï∞ÊçÆ</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
function filterTable() {
    const search = document.getElementById('searchSchools').value.toLowerCase();
    const region = document.getElementById('filterRegion').value;
    const source = document.getElementById('filterSource').value;
    const rows = document.querySelectorAll('#schoolsTable tbody tr');
    
    rows.forEach(row => {
        const name = row.cells[2]?.textContent.toLowerCase() || '';
        const cnName = row.cells[3]?.textContent.toLowerCase() || '';
        const rowRegion = row.dataset.region || '';
        const rowSource = row.dataset.source || '';
        
        const matchesSearch = name.includes(search) || cnName.includes(search);
        const matchesRegion = !region || rowRegion === region;
        const matchesSource = !source || rowSource === source;
        
        row.style.display = (matchesSearch && matchesRegion && matchesSource) ? '' : 'none';
    });
}
</script>

<style>
.stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
}

.stat-card:nth-child(2) {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.stat-card:nth-child(3) {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.stat-card:nth-child(4) {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.stat-number {
    font-size: 32px;
    font-weight: bold;
}

.stat-label {
    font-size: 14px;
    opacity: 0.9;
    margin-top: 5px;
}

.filter-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filter-bar input,
.filter-bar select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.filter-bar input {
    flex: 1;
    min-width: 200px;
}

.table-badge {
    width: 40px;
    height: 40px;
    object-fit: contain;
    border-radius: 5px;
}

.school-link {
    color: #333;
    text-decoration: none;
}

.school-link:hover {
    color: #667eea;
}

.source-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 500;
}

.source-schooland {
    background: #e3f2fd;
    color: #1976d2;
}

.source-manual {
    background: #f5f5f5;
    color: #666;
}

.action-group {
    display: flex;
    gap: 5px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
}

.admin-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.admin-header h1 {
    margin: 0;
    font-size: 24px;
    color: #333;
}
</style>
{% endblock %}
